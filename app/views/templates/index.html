{% extends "base.html" %}

{% block  content %}

    <div id="search-bar">
        <form action="/" method="POST">
            <input type="text" id="search" placeholder="Search.." name="search">
            <button type="submit" id="search_submit">Submit</button>
        </form>
    </div>
    <div id="result"><div id="movie"></div></div>
    <div id="movie_content"></div>

<script>

    $("#search_submit").click((e) => {
        e.preventDefault();

        $('#result').show()

        $.ajax({
            method: 'POST',
            url: '{{ url_for('search') }}',
            data: {'search_term': $(search).val()},
            success: (response) => {
                show_result(response);
            },
            datatype: 'json'
        })
    })
{#TODO: add alt picture om inte poster existerar#}
        function show_result(response) {
            $('#result').empty()

            $.each(response, (i, movie)=> {

                let title =  $("<p>").text(movie['Title']);
                let poster = $("<img>")
                    .attr("src", response[i]['Poster'])
                    .attr("onClick",'show_movie(this)')
                    .attr("id",response[i]['imdbID'])
                    .attr("class", "poster");




                let add =  $("<button>")
                    .attr("id", response[i]['imdbID'])
                    .attr("onClick", "add_movie_to_watchlist(this)")
                    .text("Add movie to Watchlist")
                    .attr("movie", JSON.stringify(movie));

                let movie_box = $("<div>")
                    .attr("id", "movie-box");

                let flex_br = $("<div>")
                    .attr("id", "break");

                {% if current_user.is_authenticated %}
                    $(movie_box).append(title, poster, add);
                {% else %}
                    $(movie_box).append(title, poster);
                {% endif %}

            if (i === 5) {
                $('#result').append(movie_box, flex_br);
            }
            else {
                $('#result').append(movie_box);
            }
            });
        }

          function add_movie_to_watchlist(element) {

            $(element).each( function () {
                $(this).val( $(this).attr("movie") );
            });

              $.ajax({
                method: 'PUT',
                url: '{{ url_for('put_watchlist', username=current_user.username) }}',
                data: {'movie': $(element).val()},
                success: (response) => {
                           console.log(response);
                },
                datatype: 'json'
            })
        }

        function show_movie(element) {
              $.ajax({
                  method: 'POST',
                  url: '{{ url_for('get_movie') }}',
                  data: {'imdb_id': element.id},
                  success: (response) => {
                      console.log(response)
                       $(result).hide();
                       $('#movie_content').empty().append(JSON.stringify(response));
                  },
                  datatype: 'json'
              });
        }

    </script>


{% endblock %}