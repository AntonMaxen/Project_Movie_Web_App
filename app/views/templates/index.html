{% extends "base.html" %}

{% block  content %}

    <div id="search-bar">
        <form action="/" method="POST">
            <input type="text" id="search" placeholder="Search.." name="search">
            <button type="submit" id="search_submit">Submit</button>
        </form>
    </div>
    <div id="result"></div>
    <div id="movie_content"></div>

    <script>

        $("#search_submit").click((e) => {
            e.preventDefault();

            $('#result').show()

            $.ajax({
                method: 'POST',
                url: '{{ url_for('search') }}',
                data: {'search_term': $(search).val()},
                success: (response) => {
                    show_result(response);
                },
                datatype: 'json'
            })
        })

        let movies = "";

        function show_result(response) {

            movies = response;
             $('#result').empty()


            $.each(movies, (i, movie)=> {


                let title =  $("<p>").text(movie['Title']);
                let poster = $("<img>")
                    .attr("src", response[i]['Poster'])
                    .attr("onClick",'show_movie(this)')
                    .attr("id",response[i]['imdbID'])
                    .attr("data", movie);

                let add =  $("<button>")
                    .attr("id", response[i]['imdbID'])
                    .attr("onClick", "add_movie_to_watchlist(this)")
                    .text("Add movie to Watchlist");

                {% if current_user.is_authenticated %}
                $('#result').append(title, poster, add);
                {% else %}
                 $('#result').append(title, poster);
                {% endif %}
            });
        }

        function add_movie_to_watchlist(element) {
            let movie;

            $.each(movies, (i, m)=> {
                if (m['imdbID'] === element.id) {
                    movie = m;
                }
            });

              $.ajax({
                method: 'PUT',
                url: '{{ url_for('put_watchlist', username=current_user.username) }}',
                data: {'movie': JSON.stringify(movie)},
                success: (response) => {

                },
                datatype: 'json'
            })
        }

          function add_movie_to_watchlist(element) {
            let movie;

            $.each(movies, (i, m)=> {
                if (m['imdbID'] === element.id) {
                    movie = m;
                    console.log(movie)
                }
            });

              $.ajax({
                method: 'PUT',
                url: '{{ url_for('put_watchlist', username=current_user.username) }}',
                data: {'movie': JSON.stringify(movie)},
                success: (response) => {
                           console.log(response)
                },
                datatype: 'json'
            })
        }

        function show_movie(element) {

              $.ajax({
                  method: 'POST',
                  url: '{{ url_for('get_movie') }}',
                  data: {'imdb_id': element.id},
                  success: (response) => {
                      console.log(response)
                       $(result).hide();
                       $('#movie_content').empty().append(JSON.stringify(response));
                  },
                  datatype: 'json'
              });
        }
    </script>

{% endblock %}

{#$(search).keyup(()=> {#}
{#    $.ajax ({#}
{#        method: 'POST',#}
{#        url: 'http://127.0.0.1:5000/search',#}
{#        data: {'current_value': $(search).val()},#}
{#        success: (response) => {#}
{#            $('#title').text(response)#}
{#            console.log(response);#}
{#        },#}
{#        datatype: 'json'#}
{#    })#}
// {#})#}

{#response = JSON.parse(response)#}
{#$('#title').text(response.title);#}
{#$('#poster').attr("src",response.poster);#}